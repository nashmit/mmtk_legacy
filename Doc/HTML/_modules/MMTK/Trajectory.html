

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MMTK.Trajectory &mdash; MMTK User Guide 2.7.7 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.7.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="MMTK User Guide 2.7.7 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">MMTK User Guide 2.7.7 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for MMTK.Trajectory</h1><div class="highlight"><pre>
<span class="c"># This module implements trajetories and trajectory generators.</span>
<span class="c">#</span>
<span class="c"># Written by Konrad Hinsen</span>
<span class="c">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Trajectory files and their contents</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__docformat__</span> <span class="o">=</span> <span class="s">&#39;restructuredtext&#39;</span>

<span class="kn">from</span> <span class="nn">MMTK</span> <span class="kn">import</span> <span class="n">Collections</span><span class="p">,</span> <span class="n">Units</span><span class="p">,</span> <span class="n">Universe</span><span class="p">,</span> <span class="n">Utility</span><span class="p">,</span> \
                 <span class="n">ParticleProperties</span><span class="p">,</span> <span class="n">Visualization</span>
<span class="kn">from</span> <span class="nn">Scientific.Geometry</span> <span class="kn">import</span> <span class="n">Vector</span>
<span class="kn">from</span> <span class="nn">Scientific</span> <span class="kn">import</span> <span class="n">N</span>
<span class="kn">import</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="c"># Report error if the netCDF module is not available.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Scientific.IO</span> <span class="kn">import</span> <span class="n">NetCDF</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">Utility</span><span class="o">.</span><span class="n">MMTKError</span><span class="p">(</span><span class="s">&quot;Trajectories are not available &quot;</span> <span class="o">+</span>
                             <span class="s">&quot;because the netCDF module is missing.&quot;</span><span class="p">)</span>
<span class="c">#</span>
<span class="c"># Trajectory class</span>
<span class="c">#</span>
<div class="viewcode-block" id="Trajectory"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.Trajectory">[docs]</a><span class="k">class</span> <span class="nc">Trajectory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c">#</span>
    <span class="c"># Trajectory cache</span>
    <span class="c">#</span>
    <span class="c"># This cache is maintained for better efficiency in parallel</span>
    <span class="c"># processing. The cache contains all trajectories currently open</span>
    <span class="c"># for reading. When a trajectory object is unpickled, a trajectory</span>
    <span class="c"># from the cache is reused if possible. This means that </span>


    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trajectory file</span>

<span class="sd">    The data in a trajectory file can be accessed by step or by</span>
<span class="sd">    variable. If t is a Trajectory object, then:</span>

<span class="sd">     * len(t) is the number of steps</span>
<span class="sd">     * t[i] is the data for step i, in the form of a dictionary that</span>
<span class="sd">       maps variable names to data</span>
<span class="sd">     * t[i:j] and t[i:j:n] return a :class:`~MMTK.Trajectory.SubTrajectory` </span>
<span class="sd">       object that refers to a subset of the total number of steps </span>
<span class="sd">       (no data is copied)</span>
<span class="sd">     * t.variable returns the value of the named variable at all</span>
<span class="sd">       time steps. If the variable is a simple scalar, it is read</span>
<span class="sd">       completely and returned as an array. If the variable contains</span>
<span class="sd">       data for each atom, a :class:`~MMTK.Trajectory.TrajectoryVariable` </span>
<span class="sd">       object is returned from which data at specific steps can be obtained </span>
<span class="sd">       by further indexing operations.</span>

<span class="sd">    The routines that generate trajectories decide what variables</span>
<span class="sd">    are used and what they contain. The most frequently used variable</span>
<span class="sd">    is &quot;configuration&quot;, which stores the positions of all atoms.</span>
<span class="sd">    Other common variables are &quot;time&quot;, &quot;velocities&quot;, &quot;temperature&quot;,</span>
<span class="sd">    &quot;pressure&quot;, and various energy terms whose name end with &quot;_energy&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">double_precision</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">cycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param object: the object whose data is stored in the trajectory file.</span>
<span class="sd">                       This can be &#39;None&#39; when opening a file for reading;</span>
<span class="sd">                       in that case, a universe object is constructed from the</span>
<span class="sd">                       description stored in the trajectory file. This universe</span>
<span class="sd">                       object can be accessed via the attribute &#39;universe&#39;</span>
<span class="sd">                       of the trajectory object.</span>
<span class="sd">        :type object: :class:`~MMTK.ChemicalObjects.ChemicalObject`</span>
<span class="sd">        :param filename: the name of the trajectory file</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param mode: one of &quot;r&quot; (read-only), &quot;w&quot; (create new file for writing),</span>
<span class="sd">                     or &quot;a&quot; (append to existing file or create if the file does</span>
<span class="sd">                     not exist)</span>
<span class="sd">        :type mode: str</span>
<span class="sd">        :param comment: optional comment that is stored in the file;</span>
<span class="sd">                        allowed only with mode=&quot;r&quot;</span>
<span class="sd">        :type comment: str</span>
<span class="sd">        :param double_precision: if True, data in the file is stored using</span>
<span class="sd">                                 double precision; default is single precision.</span>
<span class="sd">                                 Note that all I/O via trajectory objects is</span>
<span class="sd">                                 double precision; conversion from and to</span>
<span class="sd">                                 single precision file variables is handled</span>
<span class="sd">                                 automatically.</span>
<span class="sd">        :type double_precision: bool</span>
<span class="sd">        :param cycle: if non-zero, a trajectory is created for a fixed number</span>
<span class="sd">                      of steps equal to the value of cycle, and these steps</span>
<span class="sd">                      are used cyclically. This is meant for restart</span>
<span class="sd">                      trajectories.</span>
<span class="sd">        :type cycle: int</span>
<span class="sd">        :param block_size: an optimization parameter that influences the file</span>
<span class="sd">                           structure and the I/O performance for very large</span>
<span class="sd">                           files. A block size of 1 is optimal for sequential</span>
<span class="sd">                           access to configurations etc., whereas a block size</span>
<span class="sd">                           equal to the number of steps is optimal for reading</span>
<span class="sd">                           coordinates or scalar variables along the time axis.</span>
<span class="sd">                           The default value is 1. Note that older MMTK releases</span>
<span class="sd">                           always used a block size of 1 and cannot handle</span>
<span class="sd">                           trajectories with different block sizes.</span>
<span class="sd">        :type block_size: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="nb">object</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="n">NetCDF</span><span class="o">.</span><span class="n">NetCDFFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s">&#39;minor_step_number&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">conf_var</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;configuration&#39;</span><span class="p">]</span>
                    <span class="n">conf</span> <span class="o">=</span> <span class="n">conf_var</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;box_size&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">conf_var</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;configuration&#39;</span><span class="p">]</span>
                    <span class="n">conf</span> <span class="o">=</span> <span class="n">conf_var</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;box_size&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="kn">import</span> <span class="nn">Skeleton</span>
            <span class="n">local</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">skeleton</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="nb">vars</span><span class="p">(</span><span class="n">Skeleton</span><span class="p">),</span> <span class="n">local</span><span class="p">)</span>
            <span class="n">universe</span> <span class="o">=</span> <span class="n">skeleton</span><span class="o">.</span><span class="n">make</span><span class="p">({},</span> <span class="n">conf</span><span class="p">)</span>
            <span class="n">universe</span><span class="o">.</span><span class="n">setCellParameters</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
            <span class="nb">object</span> <span class="o">=</span> <span class="n">universe</span>
            <span class="n">initialize</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">universe</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">universe</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">universe</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;objects not in the same universe&quot;</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">initialize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">universe</span><span class="o">.</span><span class="n">configuration</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">object</span> <span class="ow">is</span> <span class="n">universe</span><span class="p">:</span>
            <span class="n">index_map</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">inverse_map</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;can&#39;t read trajectory for a non-universe&quot;</span><span class="p">)</span>
            <span class="n">index_map</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span>  <span class="nb">object</span><span class="o">.</span><span class="n">atomList</span><span class="p">()])</span>
            <span class="n">inverse_map</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">numberOfPoints</span><span class="p">()</span><span class="o">*</span><span class="p">[</span><span class="bp">None</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index_map</span><span class="p">)):</span>
                <span class="n">inverse_map</span><span class="p">[</span><span class="n">index_map</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">toplevel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">Collections</span><span class="o">.</span><span class="n">Collection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
                <span class="n">toplevel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">topLevelChemicalObject</span><span class="p">())</span>
            <span class="nb">object</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="n">Collection</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">toplevel</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">description</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">inverse_map</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">MMTK_trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">MMTK_trajectory</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span>
                                                     <span class="n">index_map</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                                                     <span class="n">mode</span> <span class="o">+</span> <span class="s">&#39;s&#39;</span><span class="p">,</span>
                                                     <span class="n">double_precision</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span>
                                                     <span class="n">block_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span> <span class="o">=</span> <span class="n">index_map</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s">&#39;minor_step_number&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&#39;cannot add comment in read-only mode&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span>
        <span class="k">if</span> <span class="n">initialize</span> <span class="ow">and</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">setFromTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_trajectory_reader</span> <span class="o">=</span> <span class="n">ParticleTrajectoryReader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s">&#39;r&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot copy or pickle write-mode trajectories&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

<div class="viewcode-block" id="Trajectory.flush"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.Trajectory.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure that all data that has been written to the trajectory</span>
<span class="sd">        is also written to the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Trajectory.close"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.Trajectory.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the trajectory file. Must be called after writing to</span>
<span class="sd">        ensure that all buffered data is written to the file. No data</span>
<span class="sd">        access is possible after closing a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">nsteps</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">SubTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&#39;step_number&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s">&#39;atom_number&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;xyz&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">ParticleProperties</span><span class="o">.</span><span class="n">ParticleVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">readParticleVector</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">ParticleProperties</span><span class="o">.</span><span class="n">ParticleScalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">readParticleScalar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span>
                <span class="k">if</span> <span class="n">bs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">item</span><span class="o">/</span><span class="n">bs</span><span class="p">,</span> <span class="n">item</span><span class="o">%</span><span class="n">bs</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">item</span><span class="o">/</span><span class="n">bs</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">item</span><span class="o">%</span><span class="n">bs</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="o">+</span><span class="n">array</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;configuration&#39;</span><span class="p">):</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;box_size&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;configuration&#39;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;configuration&#39;</span><span class="p">]</span> <span class="o">=</span> \
               <span class="n">ParticleProperties</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__getslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">),)]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;no variable named &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;atom_number&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TrajectoryVariable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39;box_size_length&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;minor_step_number&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">var</span><span class="p">[:],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">bs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">return</span> <span class="n">bs</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">var</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">))[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">defaultStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">last_step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">step</span>

<div class="viewcode-block" id="Trajectory.readParticleTrajectory"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.Trajectory.readParticleTrajectory">[docs]</a>    <span class="k">def</span> <span class="nf">readParticleTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">variable</span> <span class="o">=</span> <span class="s">&quot;configuration&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read trajectory information for a single atom but for multiple</span>
<span class="sd">        time steps.</span>

<span class="sd">        :param atom: the atom whose trajectory is requested</span>
<span class="sd">        :type atom: :class:`~MMTK.ChemicalObjects.Atom`</span>
<span class="sd">        :param first: the number of the first step to be read</span>
<span class="sd">        :type first: int</span>
<span class="sd">        :param last: the number of the first step not to be read.</span>
<span class="sd">                     A value of None indicates that the</span>
<span class="sd">                     whole trajectory should be read.</span>
<span class="sd">        :type last: int</span>
<span class="sd">        :param skip: the number of steps to skip between two steps read</span>
<span class="sd">        :type skip: int</span>
<span class="sd">        :param variable: the name of the trajectory variable to be read.</span>
<span class="sd">                         If the variable is &quot;configuration&quot;, the resulting</span>
<span class="sd">                         trajectory is made continuous by eliminating all</span>
<span class="sd">                         jumps caused by periodic boundary conditions.</span>
<span class="sd">                         The pseudo-variable &quot;box_coordinates&quot; can be read</span>
<span class="sd">                         to obtain the values of the variable &quot;configuration&quot;</span>
<span class="sd">                         scaled to box coordinates. For non-periodic universes</span>
<span class="sd">                         there is no difference between box coordinates</span>
<span class="sd">                         and real coordinates.</span>
<span class="sd">        :type variable: str</span>
<span class="sd">        :returns: the trajectory for a single atom</span>
<span class="sd">        :rtype: :class:`~MMTK.Trajectory.ParticleTrajectory`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ParticleTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trajectory.readRigidBodyTrajectory"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.Trajectory.readRigidBodyTrajectory">[docs]</a>    <span class="k">def</span> <span class="nf">readRigidBodyTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">reference</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the positions for an object at multiple time steps</span>
<span class="sd">        and extract the rigid-body motion (center-of-mass position plus</span>
<span class="sd">        orientation as a quaternion) by an optimal-transformation fit.</span>

<span class="sd">        :param object: the object whose rigid-body trajectory is requested</span>
<span class="sd">        :type object: :class:`~MMTK.Collections.GroupOfAtoms`</span>
<span class="sd">        :param first: the number of the first step to be read</span>
<span class="sd">        :type first: int</span>
<span class="sd">        :param last: the number of the first step not to be read.</span>
<span class="sd">                     A value of None indicates that the</span>
<span class="sd">                     whole trajectory should be read.</span>
<span class="sd">        :type last: int</span>
<span class="sd">        :param skip: the number of steps to skip between two steps read</span>
<span class="sd">        :type skip: int</span>
<span class="sd">        :param reference: the reference configuration for the fit</span>
<span class="sd">        :type reference: :class:`~MMTK.ParticleProperties.Configuration`</span>
<span class="sd">        :returns: the trajectory for a single rigid body</span>
<span class="sd">        :rtype: :class:`~MMTK.Trajectory.RigidBodyTrajectory`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RigidBodyTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Trajectory.variables"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.Trajectory.variables">[docs]</a>    <span class="k">def</span> <span class="nf">variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: a list of the names of all variables that are stored</span>
<span class="sd">                  in the trajectory</span>
<span class="sd">        :rtype: list of str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="nb">vars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;step&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">vars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">return</span> <span class="nb">vars</span>
</div>
<div class="viewcode-block" id="Trajectory.view"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.Trajectory.view">[docs]</a>    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">object</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show an animation of the trajectory using an external visualization</span>
<span class="sd">        program.</span>

<span class="sd">        :param first: the number of the first step in the animation</span>
<span class="sd">        :type first: int</span>
<span class="sd">        :param last: the number of the first step not to include in the</span>
<span class="sd">                     animation. A value of None indicates that the</span>
<span class="sd">                     whole trajectory should be used.</span>
<span class="sd">        :type last: int</span>
<span class="sd">        :param skip: the number of steps to skip between two steps read</span>
<span class="sd">        :type skip: int</span>
<span class="sd">        :param object: the object to be animated, which must be in the</span>
<span class="sd">                       universe stored in the trajectory. None</span>
<span class="sd">                       stands for the whole universe.</span>
<span class="sd">        :type object: :class:`~MMTK.Collections.GroupOfAtoms`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Visualization</span><span class="o">.</span><span class="n">viewTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_boxTransformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt_in</span><span class="p">,</span> <span class="n">pt_out</span><span class="p">,</span> <span class="n">to_box</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">MMTK_trajectory</span> <span class="kn">import</span> <span class="n">boxTransformation</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">box_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">recently_read_box_size</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">boxTransformation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">_spec</span><span class="p">,</span>
                          <span class="n">pt_in</span><span class="p">,</span> <span class="n">pt_out</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">to_box</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="SubTrajectory"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.SubTrajectory">[docs]</a><span class="k">class</span> <span class="nc">SubTrajectory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reference to a subset of a trajectory</span>

<span class="sd">    A SubTrajectory object is created by slicing a Trajectory object</span>
<span class="sd">    or another SubTrajectory object. It provides all the operations</span>
<span class="sd">    defined on Trajectory objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">universe</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">item</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SubTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__getslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">),)]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SubVariable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readParticleTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">variable</span> <span class="o">=</span> <span class="s">&quot;configuration&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">:</span><span class="n">skip</span><span class="p">]</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">readParticleTrajectory</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span>
                                                      <span class="n">skip</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readRigidBodyTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">reference</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">:</span><span class="n">skip</span><span class="p">]</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">RigidBodyTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span>
                                   <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">variables</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">Visualization</span><span class="o">.</span><span class="n">viewTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span>

    <span class="k">def</span> <span class="nf">_boxTransformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt_in</span><span class="p">,</span> <span class="n">pt_out</span><span class="p">,</span> <span class="n">to_box</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Trajectory</span><span class="o">.</span><span class="n">_boxTransformation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">pt_in</span><span class="p">,</span> <span class="n">pt_out</span><span class="p">,</span> <span class="n">to_box</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Trajectory variables</span>
<span class="c">#</span></div>
<div class="viewcode-block" id="TrajectoryVariable"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.TrajectoryVariable">[docs]</a><span class="k">class</span> <span class="nc">TrajectoryVariable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Variable in a trajectory</span>

<span class="sd">    A TrajectoryVariable object is created by extracting a variable from</span>
<span class="sd">    a Trajectory object if that variable contains data for each atom and</span>
<span class="sd">    is thus potentially large. No data is read from the trajectory file</span>
<span class="sd">    when a TrajectoryVariable object is created; the read operation</span>
<span class="sd">    takes place when the TrajectoryVariable is indexed with a specific</span>
<span class="sd">    step number.</span>

<span class="sd">    If t is a TrajectoryVariable object, then:</span>

<span class="sd">     * len(t) is the number of steps</span>
<span class="sd">     * t[i] is the data for step i, in the form of a ParticleScalar,</span>
<span class="sd">       a ParticleVector, or a Configuration object, depending on the</span>
<span class="sd">       variable</span>
<span class="sd">     * t[i:j] and t[i:j:n] return a SubVariable object that refers</span>
<span class="sd">       to a subset of the total number of steps</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;configuration&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;box_size&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">SubVariable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))[</span><span class="n">item</span><span class="p">]</span>
        <span class="n">item</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="c"># gets rid of numpy.intXX objects</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;configuration&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_size</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">block_size</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span><span class="p">[</span><span class="n">item</span><span class="o">/</span><span class="n">bs</span><span class="p">,</span> <span class="p">:,</span> <span class="n">item</span><span class="o">%</span><span class="n">bs</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_size</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">ParticleProperties</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">readParticleVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span>
                <span class="n">box</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39;xyz&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">ParticleProperties</span><span class="o">.</span><span class="n">ParticleVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">readParticleVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">ParticleProperties</span><span class="o">.</span><span class="n">ParticleScalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">readParticleScalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">array</span>

    <span class="k">def</span> <span class="nf">__getslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">),)]</span>

    <span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">sum</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="nb">sum</span> <span class="o">=</span> <span class="nb">sum</span> <span class="o">+</span> <span class="n">value</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SubVariable"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.SubVariable">[docs]</a><span class="k">class</span> <span class="nc">SubVariable</span><span class="p">(</span><span class="n">TrajectoryVariable</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reference to a subset of a :class:`~MMTK.Trajectory.TrajectoryVariable`</span>

<span class="sd">    A SubVariable object is created by slicing a TrajectoryVariable</span>
<span class="sd">    object or another SubVariable object. It provides all the operations</span>
<span class="sd">    defined on TrajectoryVariable objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable</span> <span class="o">=</span> <span class="n">variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SubVariable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__getslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">),)]</span>

<span class="c">#</span>
<span class="c"># Trajectory consisting of multiple files</span>
<span class="c">#</span></div>
<div class="viewcode-block" id="TrajectorySet"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.TrajectorySet">[docs]</a><span class="k">class</span> <span class="nc">TrajectorySet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trajectory file set</span>

<span class="sd">    A TrajectorySet permits to treat a sequence of trajectory files</span>
<span class="sd">    like a single trajectory for reading data. It behaves exactly like a</span>
<span class="sd">    :class:`~MMTK.Trajectory.Trajectory` object. The trajectory files must all contain data</span>
<span class="sd">    for the same system. The variables stored in the individual files</span>
<span class="sd">    need not be the same, but only variables common to all files</span>
<span class="sd">    can be accessed.</span>

<span class="sd">    Note: depending on how the sequence of trajectories was constructed,</span>
<span class="sd">    the first configuration of each trajectory might be the same as the</span>
<span class="sd">    last one in the preceding trajectory. To avoid counting it twice,</span>
<span class="sd">    specify (filename, 1, None, 1) for all but the first trajectory in</span>
<span class="sd">    the set.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param object: the object whose data is stored in the trajectory files.</span>
<span class="sd">                       This can be (and usually is) None;</span>
<span class="sd">                       in that case, a universe object is constructed from the</span>
<span class="sd">                       description stored in the first trajectory file.</span>
<span class="sd">                       This universe object can be accessed via the attribute</span>
<span class="sd">                       universe of the trajectory set object.</span>
<span class="sd">        :param filenames: a list of trajectory file names or</span>
<span class="sd">                          (filename, first_step, last_step, increment)</span>
<span class="sd">                          tuples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">first</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">first</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">first</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">first</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span> <span class="o">=</span> <span class="p">[</span><span class="n">first</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="nb">file</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="nb">file</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="nb">file</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="nb">file</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;box_size&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">variables</span><span class="p">():</span>
                <span class="nb">vars</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">SubTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span>
        <span class="n">tindex</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">[</span><span class="n">tindex</span><span class="p">][</span><span class="n">item</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="n">tindex</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">__getslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">),)]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;step&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;no variable named &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;atom_number&#39;</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TrajectorySetVariable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">))[:</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readParticleTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">variable</span> <span class="o">=</span> <span class="s">&quot;configuration&quot;</span><span class="p">):</span>
        <span class="n">total</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_read</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">first</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">steps_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">first</span><span class="o">+</span><span class="n">skip</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">skip</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">first</span><span class="o">+</span><span class="n">skip</span><span class="o">*</span><span class="n">n</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">first</span><span class="o">+</span><span class="n">skip</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">skip</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">first</span><span class="o">+</span><span class="n">skip</span><span class="o">*</span><span class="n">n</span>
            <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">readParticleTrajectory</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span>
                                              <span class="n">variable</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">steps_read</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="n">skip</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="n">pt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s">&quot;configuration&quot;</span> \
                       <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">jump</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">total</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">mult</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">jump</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mult</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">t</span><span class="o">.</span><span class="n">_boxTransformation</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">mult</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">NewAxis</span><span class="p">,</span> <span class="p">:</span> <span class="p">],</span>
                                        <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
                            <span class="n">t</span><span class="o">.</span><span class="n">_boxTransformation</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">jump</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">total</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">jump</span><span class="p">,</span>
                                            <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span> \
                               <span class="n">N</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">jump</span><span class="p">,</span>
                                               <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">t</span><span class="o">.</span><span class="n">_boxTransformation</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">NewAxis</span><span class="p">,</span> <span class="p">:],</span>
                                        <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
                            <span class="n">t</span><span class="o">.</span><span class="n">_boxTransformation</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">variable</span> <span class="o">==</span> <span class="s">&quot;box_coordinates&quot;</span> \
                       <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">jump</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">total</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">mult</span> <span class="o">=</span> <span class="o">-</span><span class="n">jump</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mult</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">mult</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">NewAxis</span><span class="p">,</span> <span class="p">:</span> <span class="p">],</span>
                                        <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
                            <span class="n">jump</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">total</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">jump</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">-</span> \
                               <span class="n">N</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">jump</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">NewAxis</span><span class="p">,</span> <span class="p">:],</span>
                                        <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
                    <span class="n">total</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">total</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">array</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">steps_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total</span>

    <span class="k">def</span> <span class="nf">readRigidBodyTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">reference</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RigidBodyTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_boxTransformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt_in</span><span class="p">,</span> <span class="n">pt_out</span><span class="p">,</span> <span class="n">to_box</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_read</span><span class="p">)):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_read</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">_boxTransformation</span><span class="p">(</span><span class="n">pt_in</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">steps</span><span class="p">],</span> <span class="n">pt_out</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="n">steps</span><span class="p">],</span>
                                     <span class="n">to_box</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">steps</span>

    <span class="k">def</span> <span class="nf">variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span>

    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">object</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">Visualization</span><span class="o">.</span><span class="n">viewTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="TrajectorySetVariable"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.TrajectorySetVariable">[docs]</a><span class="k">class</span> <span class="nc">TrajectorySetVariable</span><span class="p">(</span><span class="n">TrajectoryVariable</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Variable in a trajectory set</span>

<span class="sd">    A TrajectorySetVariable object is created by extracting a variable from</span>
<span class="sd">    a TrajectorySet object if that variable contains data for each atom and</span>
<span class="sd">    is thus potentially large. It behaves exactly like a TrajectoryVariable</span>
<span class="sd">    object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="n">trajectory_set</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_set</span> <span class="o">=</span> <span class="n">trajectory_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory_set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">SubVariable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory_set</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IndexError</span>
        <span class="n">tindex</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">item</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_set</span><span class="o">.</span><span class="n">nsteps</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">item</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory_set</span><span class="o">.</span><span class="n">nsteps</span><span class="p">[</span><span class="n">tindex</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_set</span><span class="o">.</span><span class="n">trajectories</span><span class="p">[</span><span class="n">tindex</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="n">step</span><span class="p">]</span>

<span class="c">#</span>
<span class="c"># Cache for atom trajectories</span>
<span class="c">#</span></div>
<span class="k">class</span> <span class="nc">ParticleTrajectoryReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">numberOfAtoms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_lifetime</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">correct</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">atom</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">index</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">universe</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">universe</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;objects not in the same universe&quot;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">correct</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_lifetime</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="n">delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">delete</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">cache_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100000</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="p">))))</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cache_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="o">-</span><span class="n">index</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory</span><span class="o">.</span><span class="n">readParticleTrajectories</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span>
                                                         <span class="n">variable</span><span class="p">,</span>
                                                         <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span>
                                                         <span class="n">correct</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">correct</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_lifetime</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c">#</span>
<span class="c"># Single-atom trajectory</span>
<span class="c">#</span>
<div class="viewcode-block" id="ParticleTrajectory"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.ParticleTrajectory">[docs]</a><span class="k">class</span> <span class="nc">ParticleTrajectory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trajectory data for a single particle</span>

<span class="sd">    A ParticleTrajectory object is created by calling the method</span>
<span class="sd">    :func:`~MMTK.Trajectory.Trajectory.readParticleTrajectory`</span>
<span class="sd">    on a :class:`~MMTK.Trajectory.Trajectory` object.</span>

<span class="sd">    If pt is a ParticleTrajectory object, then</span>

<span class="sd">     * len(pt) is the number of steps stored in it</span>
<span class="sd">     * pt[i] is the value at step i (a vector)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">variable</span> <span class="o">=</span> <span class="s">&quot;configuration&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s">&quot;box_coordinates&quot;</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="s">&quot;configuration&quot;</span>
            <span class="n">box</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">particle_trajectory_reader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span>
                            <span class="n">variable</span> <span class="o">==</span> <span class="s">&quot;configuration&quot;</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

<div class="viewcode-block" id="ParticleTrajectory.translateBy"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.ParticleTrajectory.translateBy">[docs]</a>    <span class="k">def</span> <span class="nf">translateBy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a vector to the values at all steps. This does B{not}</span>
<span class="sd">        change the data in the trajectory file.</span>

<span class="sd">        :param vector: the vector to be added</span>
<span class="sd">        :type vector: Scientific.Geometry.Vector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">vector</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">NewAxis</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Rigid-body trajectory</span>
<span class="c">#</span></div></div>
<div class="viewcode-block" id="RigidBodyTrajectory"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.RigidBodyTrajectory">[docs]</a><span class="k">class</span> <span class="nc">RigidBodyTrajectory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rigid-body trajectory data</span>

<span class="sd">    A RigidBodyTrajectory object is created by calling the method</span>
<span class="sd">    :func:`~MMTK.Trajectory.Trajectory.readRigidBodyTrajectory`</span>
<span class="sd">    on a :class:`~MMTK.Trajectory.Trajectory` object.</span>

<span class="sd">    If rbt is a RigidBodyTrajectory object, then</span>

<span class="sd">     * len(rbt) is the number of steps stored in it</span>
<span class="sd">     * rbt[i] is the value at step i (a vector for the center of mass</span>
<span class="sd">       and a quaternion for the orientation)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">reference</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span>
        <span class="n">universe</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">universe</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>
        <span class="n">first_conf</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="n">first</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">contiguousObjectOffset</span><span class="p">([</span><span class="nb">object</span><span class="p">],</span> <span class="n">first_conf</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="n">first_conf</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">universe</span><span class="o">.</span><span class="n">contiguousObjectConfiguration</span><span class="p">([</span><span class="nb">object</span><span class="p">],</span> <span class="n">reference</span><span class="p">)</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">last</span><span class="o">-</span><span class="n">first</span><span class="o">+</span><span class="n">skip</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">skip</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">mass</span><span class="p">()</span>
        <span class="n">ref_cms</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">centerOfMass</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">atomList</span><span class="p">()</span>

        <span class="n">possq</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">steps</span><span class="p">,),</span> <span class="n">N</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
        <span class="n">cross</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">steps</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
        <span class="n">rcms</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">steps</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>

        <span class="c"># cms of the CONTIGUOUS object made of CONTINUOUS atom trajectories </span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">readParticleTrajectory</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span>
                                                  <span class="s">&quot;box_coordinates&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">array</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">_mass</span><span class="o">/</span><span class="n">mass</span>
            <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rcms</span><span class="p">,</span> <span class="n">w</span><span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="n">rcms</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rcms</span><span class="p">,</span> <span class="n">w</span><span class="o">*</span><span class="n">offset</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">rcms</span><span class="p">)</span>
        
        <span class="c"># relative coords of the CONTIGUOUS reference</span>
        <span class="n">r_ref</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="n">r_ref</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span><span class="o">.</span><span class="n">array</span> <span class="o">-</span> <span class="n">ref_cms</span><span class="o">.</span><span class="n">array</span>

        <span class="c"># main loop: storing data needed to fill M matrix </span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">readParticleTrajectory</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
                                                  <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span>
                                                  <span class="s">&quot;box_coordinates&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">array</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">rcms</span> <span class="c"># (a-b)**2 != a**2 - b**2</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">offset</span><span class="p">[</span><span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
            <span class="n">trajectory</span><span class="o">.</span><span class="n">_boxTransformation</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">_mass</span><span class="o">/</span><span class="n">mass</span>
            <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">possq</span><span class="p">,</span> <span class="n">w</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">possq</span><span class="p">)</span>
            <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">possq</span><span class="p">,</span> <span class="n">w</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">r_ref</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">*</span><span class="n">r_ref</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">possq</span><span class="p">)</span>
            <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cross</span><span class="p">,</span> <span class="n">w</span><span class="o">*</span><span class="n">r</span><span class="p">[:,:,</span><span class="n">N</span><span class="o">.</span><span class="n">NewAxis</span><span class="p">]</span><span class="o">*</span><span class="n">r_ref</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">NewAxis</span><span class="p">,</span>
                                                              <span class="n">a</span><span class="p">,:],</span><span class="n">cross</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">_boxTransformation</span><span class="p">(</span><span class="n">rcms</span><span class="p">,</span> <span class="n">rcms</span><span class="p">)</span>

        <span class="c"># filling matrix M (formula no 40)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">steps</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
        <span class="n">k</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">k</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">k</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">k</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">k</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">k</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">k</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">k</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">k</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">k</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cross</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">cross</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">k</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">N</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="n">possq</span><span class="p">,</span> <span class="n">k</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">possq</span>

        <span class="n">quaternions</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">steps</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">steps</span><span class="p">,),</span> <span class="n">N</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">Scientific.LA</span> <span class="kn">import</span> <span class="n">eigenvectors</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">fit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span> <span class="n">quaternions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="c"># eliminate jumps</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">quaternions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="n">fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cms</span> <span class="o">=</span> <span class="n">rcms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span> <span class="o">=</span> <span class="n">quaternions</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">Scientific.Geometry.Quaternion</span> <span class="kn">import</span> <span class="n">Quaternion</span>
        <span class="k">return</span> <span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cms</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> <span class="n">Quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quaternions</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

<span class="c">#</span>
<span class="c"># Type check for trajectory objects</span>
<span class="c">#</span></div>
<div class="viewcode-block" id="isTrajectory"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.isTrajectory">[docs]</a><span class="k">def</span> <span class="nf">isTrajectory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param object: any Python object</span>
<span class="sd">    :returns: True if object is a trajectory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">MMTK_trajectory</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="p">(</span><span class="n">Trajectory</span><span class="p">,</span> <span class="n">MMTK_trajectory</span><span class="o">.</span><span class="n">trajectory_type</span><span class="p">))</span>

<span class="c">#</span>
<span class="c"># Base class for all objects that generate trajectories</span>
<span class="c">#</span></div>
<div class="viewcode-block" id="TrajectoryGenerator"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.TrajectoryGenerator">[docs]</a><span class="k">class</span> <span class="nc">TrajectoryGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trajectory generator base class</span>

<span class="sd">    This base class implements the common aspects of everything that</span>
<span class="sd">    generates trajectories: integrators, minimizers, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>

    <span class="k">def</span> <span class="nf">setCallOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_options</span> <span class="o">=</span> <span class="n">options</span>

    <span class="k">def</span> <span class="nf">getActions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;actions&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;background&#39;</span><span class="p">):</span>
                <span class="kn">import</span> <span class="nn">MMTK_state_accessor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_accessor</span> <span class="o">=</span> <span class="n">MMTK_state_accessor</span><span class="o">.</span><span class="n">StateAccessor</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_accessor</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;steps&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">steps</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">getSpecificationList</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cleanupActions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getOption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;undefined option: &#39;</span> <span class="o">+</span> <span class="n">option</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">optionString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">o</span> <span class="o">+</span> <span class="s">&#39;=&#39;</span> <span class="o">+</span> <span class="sb">`self.getOption(o)`</span> <span class="o">+</span> <span class="s">&#39;, &#39;</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;background&#39;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">ThreadManager</span>
            <span class="k">return</span> <span class="n">ThreadManager</span><span class="o">.</span><span class="n">TrajectoryGeneratorThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span>
                                      <span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_accessor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">apply</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        
<span class="c">#</span>
<span class="c"># Trajectory action base class</span>
<span class="c">#</span></div>
<div class="viewcode-block" id="TrajectoryAction"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.TrajectoryAction">[docs]</a><span class="k">class</span> <span class="nc">TrajectoryAction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trajectory action base class</span>

<span class="sd">    Subclasses of this base class implement the actions that can be</span>
<span class="sd">    inserted into trajectory generation at regular intervals.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="n">first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">last</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="n">skip</span>

    <span class="n">spec_type</span> <span class="o">=</span> <span class="s">&#39;function&#39;</span>

    <span class="k">def</span> <span class="nf">_getSpecificationList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory_generator</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
        <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first</span>
        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last</span>
        <span class="k">if</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="n">steps</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">MMTK_trajectory</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">MMTK_trajectory</span><span class="o">.</span><span class="n">maxint</span>
        <span class="k">elif</span> <span class="n">last</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">last</span> <span class="o">+</span> <span class="n">steps</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_type</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getSpecificationList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory_generator</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getSpecificationList</span><span class="p">(</span><span class="n">trajectory_generator</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span> \
               <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cfunction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="TrajectoryOutput"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.TrajectoryOutput">[docs]</a><span class="k">class</span> <span class="nc">TrajectoryOutput</span><span class="p">(</span><span class="n">TrajectoryAction</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trajectory output action</span>

<span class="sd">    A TrajectoryOutput object can be used in the action list of any</span>
<span class="sd">    trajectory-generating operation. It writes any of the available</span>
<span class="sd">    data to a trajectory file. It is possible to use several</span>
<span class="sd">    TrajectoryOutput objects at the same time in order to produce</span>
<span class="sd">    multiple trajectories from a single run.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param trajectory: a trajectory object or a string, which is</span>
<span class="sd">                           interpreted as the name of a file that is opened</span>
<span class="sd">                           as a trajectory in append mode</span>
<span class="sd">        :param data: a list of data categories. All variables provided by the</span>
<span class="sd">                     trajectory generator that fall in any of the listed</span>
<span class="sd">                     categories are written to the trajectory file. See the</span>
<span class="sd">                     descriptions of the trajectory generators for a list</span>
<span class="sd">                     of variables and categories. By default (data = None)</span>
<span class="sd">                     the categories &quot;configuration&quot;, &quot;energy&quot;,</span>
<span class="sd">                     &quot;thermodynamic&quot;, and &quot;time&quot; are written.</span>
<span class="sd">        :param first: the number of the first step at which the action is run</span>
<span class="sd">        :type first: int</span>
<span class="sd">        :param last: the number of the step at which the action is suspended.</span>
<span class="sd">                     A value of None indicates that the action should</span>
<span class="sd">                     be applied indefinitely.</span>
<span class="sd">        :type last: int</span>
<span class="sd">        :param skip: the number of steps to skip between two action runs</span>
<span class="sd">        :type skip: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">TrajectoryAction</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_be_closed</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">spec_type</span> <span class="o">=</span> <span class="s">&#39;trajectory&#39;</span>

    <span class="k">def</span> <span class="nf">getSpecificationList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory_generator</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setupDestination</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">,</span>
                                                 <span class="n">trajectory_generator</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaultCategories</span><span class="p">(</span><span class="n">trajectory_generator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;all&#39;</span><span class="p">]:</span>
                <span class="n">categories</span> <span class="o">=</span> <span class="n">trajectory_generator</span><span class="o">.</span><span class="n">available_data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">categories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trajectory_generator</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;data item </span><span class="si">%s</span><span class="s"> is not available&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getSpecificationList</span><span class="p">(</span><span class="n">trajectory_generator</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span> \
               <span class="o">+</span> <span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">categories</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setupDestination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">universe</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_be_closed</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_be_closed</span>
        
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_be_closed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">must_be_closed</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_defaultCategories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory_generator</span><span class="p">):</span>
        <span class="n">available</span> <span class="o">=</span> <span class="n">trajectory_generator</span><span class="o">.</span><span class="n">available_data</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">available</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_data</span><span class="p">))</span>

    <span class="n">default_data</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;configuration&#39;</span><span class="p">,</span> <span class="s">&#39;energy&#39;</span><span class="p">,</span> <span class="s">&#39;thermodynamic&#39;</span><span class="p">,</span> <span class="s">&#39;time&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="RestartTrajectoryOutput"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.RestartTrajectoryOutput">[docs]</a><span class="k">class</span> <span class="nc">RestartTrajectoryOutput</span><span class="p">(</span><span class="n">TrajectoryOutput</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restart trajectory output action</span>

<span class="sd">    A RestartTrajectoryOutput object is used in the action list of any</span>
<span class="sd">    trajectory-generating operation. It writes those variables to a</span>
<span class="sd">    trajectory that the trajectory generator declares as necessary</span>
<span class="sd">    for restarting.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param trajectory: a trajectory object or a string, which is interpreted</span>
<span class="sd">                           as the name of a file that is opened as a trajectory</span>
<span class="sd">                           in append mode with a cycle length of length and</span>
<span class="sd">                           double-precision variables</span>
<span class="sd">        :param skip: the number of steps between two write operations to the</span>
<span class="sd">                     restart trajectory</span>
<span class="sd">        :type skip: int</span>
<span class="sd">        :param length: the number of steps stored in the restart trajectory;</span>
<span class="sd">                       used only if trajectory is a string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">TrajectoryAction</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>

    <span class="k">def</span> <span class="nf">_setupDestination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">universe</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_be_closed</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;Restart trajectory&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_be_closed</span>
        
    <span class="k">def</span> <span class="nf">_defaultCategories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory_generator</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">trajectory_generator</span><span class="o">.</span><span class="n">restart_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Trajectory generator does not permit restart&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trajectory_generator</span><span class="o">.</span><span class="n">restart_data</span>
</div>
<div class="viewcode-block" id="LogOutput"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.LogOutput">[docs]</a><span class="k">class</span> <span class="nc">LogOutput</span><span class="p">(</span><span class="n">TrajectoryOutput</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Protocol file output action</span>

<span class="sd">    A LogOutput object can be used in the action list of any</span>
<span class="sd">    trajectory-generating operation. It writes any of the available</span>
<span class="sd">    data to a text file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param file: a file object or a string, which is interpreted as the</span>
<span class="sd">                     name of a file that is opened in write mode</span>
<span class="sd">        :param data: a list of data categories. All variables provided by the</span>
<span class="sd">                     trajectory generator that fall in any of the listed</span>
<span class="sd">                     categories are written to the trajectory file. See the</span>
<span class="sd">                     descriptions of the trajectory generators for a list</span>
<span class="sd">                     of variables and categories. By default (data = None)</span>
<span class="sd">                     the categories &quot;configuration&quot;, &quot;energy&quot;,</span>
<span class="sd">                     &quot;thermodynamic&quot;, and &quot;time&quot; are written.</span>
<span class="sd">        :param first: the number of the first step at which the action is run</span>
<span class="sd">        :type first: int</span>
<span class="sd">        :param last: the number of the step at which the action is suspended.</span>
<span class="sd">                     A value of None indicates that the action should</span>
<span class="sd">                     be applied indefinitely.</span>
<span class="sd">        :type last: int</span>
<span class="sd">        :param skip: the number of steps to skip between two action runs</span>
<span class="sd">        :type skip: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">TrajectoryOutput</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setupDestination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">universe</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_be_closed</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_be_closed</span>

    <span class="n">spec_type</span> <span class="o">=</span> <span class="s">&#39;print&#39;</span>

    <span class="n">default_data</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;energy&#39;</span><span class="p">,</span> <span class="s">&#39;time&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="StandardLogOutput"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.StandardLogOutput">[docs]</a><span class="k">class</span> <span class="nc">StandardLogOutput</span><span class="p">(</span><span class="n">LogOutput</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standard protocol output action</span>

<span class="sd">    A StandardLogOutput object can be used in the action list of any</span>
<span class="sd">    trajectory-generating operation. It is a specialization of</span>
<span class="sd">    LogOutput to the most common case and writes data in the categories</span>
<span class="sd">    &quot;time&quot; and &quot;energy&quot; to the standard output stream.</span>

<span class="sd">    :param skip: the number of steps to skip between two action runs</span>
<span class="sd">    :type skip: int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="n">LogOutput</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Snapshot generator</span>
<span class="c">#</span></div>
<div class="viewcode-block" id="SnapshotGenerator"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.SnapshotGenerator">[docs]</a><span class="k">class</span> <span class="nc">SnapshotGenerator</span><span class="p">(</span><span class="n">TrajectoryGenerator</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trajectory generator for single steps</span>

<span class="sd">    A SnapshotGenerator is used for manual assembly of trajectory</span>
<span class="sd">    files. At each call it writes one step to the trajectory,</span>
<span class="sd">    using the current state of the universe (configuration, velocities, etc.)</span>
<span class="sd">    and data provided explicitly with the call.</span>

<span class="sd">    Each call to the SnapshotGenerator object produces one step.</span>
<span class="sd">    All the keyword options can be specified either when</span>
<span class="sd">    creating the generator or when calling it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param universe: the universe on which the generator acts</span>
<span class="sd">        :keyword data: a dictionary that supplies values for variables</span>
<span class="sd">                       that are not part of the universe state</span>
<span class="sd">                       (e.g. potential energy)</span>
<span class="sd">        :keyword actions: a list of actions to be executed periodically</span>
<span class="sd">                          (default is none)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">TrajectoryGenerator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">energyAndGradients</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;energy&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;gradients&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">configuration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;configuration&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">cellVolume</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;thermodynamic&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">velocities</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;velocities&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;energy&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;thermodynamic&#39;</span><span class="p">)</span>

    <span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;steps&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCallOptions</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">MMTK_trajectory</span> <span class="kn">import</span> <span class="n">snapshot</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">energy_terms</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;time&#39;</span> <span class="ow">and</span> <span class="s">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">)</span>
            <span class="k">if</span>  <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&#39;_energy&#39;</span><span class="p">:</span>
                <span class="n">energy_terms</span> <span class="o">=</span> <span class="n">energy_terms</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="s">&#39;energy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;energy&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;temperature&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;pressure&#39;</span><span class="p">)</span> \
               <span class="ow">and</span> <span class="s">&#39;thermodynamic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;thermodynamic&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;gradients&#39;</span> <span class="ow">and</span> <span class="s">&#39;gradients&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;gradients&#39;</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getActions</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;energy&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;kinetic_energy&#39;</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">velocities</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">masses</span><span class="p">()</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">sumOverParticles</span><span class="p">()</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;kinetic_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">degreesOfFreedom</span><span class="p">()</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">e</span><span class="o">/</span><span class="n">df</span><span class="o">/</span><span class="n">Units</span><span class="o">.</span><span class="n">k_B</span><span class="o">/</span><span class="n">Units</span><span class="o">.</span><span class="n">K</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;configuration&#39;</span><span class="p">:</span>
                    <span class="k">if</span>  <span class="n">data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;configuration&#39;</span><span class="p">):</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;configuration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;configuration&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;configuration&#39;</span><span class="p">]</span> <span class="o">=</span> \
                                         <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">configuration</span><span class="p">()</span><span class="o">.</span><span class="n">array</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;velocities&#39;</span><span class="p">:</span>
                    <span class="k">if</span>  <span class="n">data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;velocities&#39;</span><span class="p">):</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;velocities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;velocities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;velocities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">velocities</span><span class="p">()</span><span class="o">.</span><span class="n">array</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;gradients&#39;</span><span class="p">:</span>
                    <span class="k">if</span>  <span class="n">data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;gradients&#39;</span><span class="p">):</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;gradients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;gradients&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">cellParameters</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;box_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">cellVolume</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">volume</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">masses</span><span class="p">()</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;masses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">array</span>
                <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">snapshot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">energy_terms</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Trajectory reader (not yet functional...)</span>
<span class="c">#</span></div>
<span class="k">if</span> <span class="bp">False</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">TrajectoryReader</span><span class="p">(</span><span class="n">TrajectoryGenerator</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
            <span class="n">TrajectoryGenerator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">trajectory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_data</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">variables</span><span class="p">()</span>

        <span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;trajectory&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;log&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;options&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setCallOptions</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">MMTK_trajectory</span> <span class="kn">import</span> <span class="n">readTrajectory</span>
            <span class="n">readTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span>
                           <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;trajectory&#39;</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">)]</span> <span class="o">+</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;options&#39;</span><span class="p">))</span>

<span class="c">#</span>
<span class="c"># Print information about trajectory file</span>
<span class="c">#</span>
<div class="viewcode-block" id="trajectoryInfo"><a class="viewcode-back" href="../../modules.html#MMTK.Trajectory.trajectoryInfo">[docs]</a><span class="k">def</span> <span class="nf">trajectoryInfo</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param filename: the name of a trajectory file</span>
<span class="sd">    :type filename: str</span>
<span class="sd">    :returns: a string with summarial information about the trajectory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">Scientific.IO</span> <span class="kn">import</span> <span class="n">NetCDF</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">NetCDF</span><span class="o">.</span><span class="n">NetCDFFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">nsteps</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;step&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;minor_step_number&#39;</span> <span class="ow">in</span> <span class="nb">file</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">nsteps</span> <span class="o">=</span> <span class="n">nsteps</span><span class="o">*</span><span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;step&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;Information about trajectory file &#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;:</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="nb">file</span><span class="o">.</span><span class="n">comment</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="sb">`file.dimensions[&#39;atom_number&#39;]`</span> <span class="o">+</span> <span class="s">&#39; atoms</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="sb">`nsteps`</span> <span class="o">+</span> <span class="s">&#39; steps</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">file</span><span class="o">.</span><span class="n">history</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">MMTK User Guide 2.7.7 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010, Konrad Hinsen.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>